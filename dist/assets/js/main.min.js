class Command{constructor(t,e){this.readLength=0,this._i=t,this._o=e,this.readLength=t.readLength+e.readLength}emulate(t,e){this._i.emulate(t,this._o,e)}fastEmulate(t){$(t.element).append(Command.DOMOpen(!1)+this._i._input.toString(this._i._input._text.length-1,!0,t,!1)+this._o.toString()+Command.DOMClose+Command.pendingCommand(t))}static pendingCommand(t){return Command.DOMOpen(!0)+Input.DOMOpen+Keystroke.prompt(t)+Keystroke.location(t)+t.pendingInput+Input.cursorHtml+Input.DOMClose+Command.DOMClose}static DOMOpen(t){return"<div class='command-container"+(t?" temp":"")+"'>"}}Command.DOMClose="</div>";class Emulator{constructor(t,e){this.user="root",this.sys="nout",this.location="~",this.pendingInput="",this.commands=t,this.element=e}emulate(){if(0===this.commands.length)return console.log("Emulate called on empty emulator. Aborting.."),1;this.commands.splice(0,1)[0].emulate(this,this.commands)}fastEmulate(){if(0===this.commands.length)return console.log("Fast emulate called on empty emulator. Aborting.."),1;for(;this.commands.length>0;){this.changeState(1),this.changeState(2),this.commands.splice(0,1)[0].fastEmulate(this),this.scrollBottom(),this.changeState(3)}}readUserInput(t){switch(!0){case 8===t.keyCode:this.scrollBottom(),this.undoChar(1);break;case t.keyCode>=65&&t.keyCode<=90:this.scrollBottom(),this.read(t.key);break;case 32===t.keyCode:this.scrollBottom(),this.read(" ");break;case 13===t.keyCode:this.scrollBottom(),this.evaluate(this.pendingInput);break;default:DEBUG&&console.log("unknown key pressed",t.keyCode,t)}}scrollBottom(){DEBUG&&console.log("scrolling to bottom of container");let t=$(this.element).parent();t.scrollTop(t.prop("scrollHeight"))}undoChar(t){this.pendingInput.slice(0,-t)}read(t){if(3!==this._state)return-1;DEBUG&&console.log("reading '"+t+"'.."),this.pendingInput+=t,$(".command-container.temp").replaceWith(Command.pendingCommand(emulator))}evaluate(t){DEBUG&&console.info("[EMULATOR] evaluating '"+t+"'..");this.commands.push(new Command(new Input(new Keystroke(t,"white",0)),new Output([new Line([new Keystroke("That didn't work..<br>Try something else?","yellow",0)])]))),this.fastEmulate()}changeState(t){switch(this._state=t,t){case 1:$(".command-container.temp").remove(),Emulator.logState(t,"emulating"),$(this.element).removeClass("hidden writing reading idle").addClass("emulating");break;case 2:Emulator.logState(t,"writing"),this.pendingInput="",$(this.element).removeClass("hidden emulating reading idle").addClass("writing");break;case 3:Emulator.logState(t,"reading"),$(this.element).removeClass("hidden emulating writing idle").addClass("reading");break;case 4:Emulator.logState(t,"hidden"),$(this.element).removeClass("emulating writing reading idle").addClass("hidden");break;default:this._state=-1,Emulator.logState(t,"idle"),$(this.element).removeClass("hidden emulating writing reading").addClass("idle")}}static logState(t,e){DEBUG&&console.info("[EMULATOR] changing state to '"+t+"',\n i.e.: '"+e+"'..")}}Emulator.readingSpeed=70,Emulator.emulationSpeed=120,Emulator.enterPause=500,Emulator.backspaceProb=.1,Emulator.idleProb=.2,Emulator.cursorInterval=700;class Input{constructor(t){this._input=t}emulate(t,e,n){t.changeState(1);const o=$(t.element).html();this._input.emulate(t,e,n,o)}static get cursorHtml(){return"<div class='cursor"+(cursorsCurrentlyShown?" shown":"")+"'></div>"}}Input.DOMOpen="<div class='input'><div class='line'>",Input.DOMClose="</div></div>";class Keystroke{constructor(t,e,n){const o=t;this.readLength=t.replace(/\s/g,"").length,this._text=o,this._css=e,this._tabs=n}toString(t,e,n,o){let a=e?Input.DOMOpen+Keystroke.prompt(n)+Keystroke.location(n):"";return a+=Keystroke._DOMOpen(this._css),a+="number"==typeof t?this._text.substring(0,t+1):this._text+Keystroke._tabString(this._tabs),a+=Keystroke._DOMClose,a+=o?Input.cursorHtml:"",a+=e?Input.DOMClose:""}emulate(t,e,n,o){this._type(t,e,n,o,0)}_type(t,e,n,o,a){const s=Command.DOMOpen(!1)+this.toString(a,!0,t,!0)+Command.DOMClose;if($(t.element).html(o+s),a>=this._text.length-1)setTimeout(function(){e.emulate(t,o,this.toString(void 0,!0,t))}.bind(this),Emulator.enterPause);else{const s=Math.random();let i=a;s<Emulator.backspaceProb?i=Math.max(0,a-1):s>=Emulator.backspaceProb+Emulator.idleProb&&(i=Math.min(a+1,this._text.length-1)),setTimeout(function(){this._type(t,e,n,o,i)}.bind(this),Emulator.emulationSpeed)}}static prompt(t){return"<span class='prompt'>"+t.user+"@"+t.sys+"</span>:"}static location(t){return"<span class='location'>"+t.location+"</span>&nbsp;"}static _DOMOpen(t){return"<span class='"+t+"'>"}static _tabString(t){return"&nbsp;".repeat(4*t)}}Keystroke._DOMClose="</span>";class Line{constructor(t){this.readLength=0,this._keystrokes=t;for(let e=0;e<t.length;e++)this.readLength+=t[e].readLength}toString(t,e){let n=Line._DOMOpen;for(let t=0;t<this._keystrokes.length;t++)n+=this._keystrokes[t].toString();return e&&(n+=Input.cursorHtml()),n+Line._DOMClose}}Line._DOMOpen="<div class='line'>",Line._DOMClose="</div>";class Output{constructor(t){this.readLength=0,this._output=t;for(let e=0;e<t.length;e++)this.readLength+=t[e].readLength}toString(){let t=Output._DOMOpen;for(let e=0;e<this._output.length;e++)t+=this._output[e].toString();return t+Output._DOMClose}pauseDuration(){const t=this.readLength*Emulator.readingSpeed;return DEBUG?.3*t:t}emulate(t,e,n){if(t.changeState(2),this.write(t,e,n),t.changeState(3),t.commands.length>0){const e=t.commands.splice(0,1);setTimeout(function(){e[0].emulate(t,t.commands)},this.pauseDuration())}}write(t,e,n){$(t.element).html(e+Command.DOMOpen(!1)+n+this.toString()+Command.DOMClose+Command.pendingCommand(t)),t.scrollBottom()}}Output._DOMOpen="<div class='output'>",Output._DOMClose="</div>";const DEBUG=!0,PACKAGE_TAG="[terminal-emulator] - ";let cursorBlinking,cursorsCurrentlyShown=!0;function terminalEmulatorInit(){return DEBUG&&console.log(PACKAGE_TAG+"DOM ready; initialising ..."),cursorBlinking=setInterval(cursorBlink,Emulator.cursorInterval),window.addEventListener?window.addEventListener("load",terminalEmulatorPageloadedWrapper,!1):window.attachEvent&&window.attachEvent("onload",terminalEmulatorPageloadedWrapper),"function"==typeof terminalEmulatorDOMReady?terminalEmulatorDOMReady():(console.warn(PACKAGE_TAG+"terminalEmulatorDOMReady() should be defined!"),1)}function terminalEmulatorPageloadedWrapper(){return DEBUG&&console.log(PACKAGE_TAG+"Page loaded; initialising trigger(s) ..."),"function"!=typeof $&&console.error(PACKAGE_TAG+"you need to load JQuery before loading me!"),"function"==typeof terminalEmulatorPageloaded?terminalEmulatorPageloaded():(console.warn(PACKAGE_TAG+"terminalEmulatorPageLoaded() should be defined!"),1)}function cursorBlink(){cursorsCurrentlyShown?($(".input .line .cursor").removeClass("shown"),cursorsCurrentlyShown=!1):($(".input .line .cursor").addClass("shown"),cursorsCurrentlyShown=!0)}document.addEventListener?document.addEventListener("DOMContentLoaded",terminalEmulatorInit,!1):document.attachEvent?document.attachEvent("onreadystatechange",terminalEmulatorInit):window.onload=terminalEmulatorInit;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvbW1hbmQuanMiLCJFbXVsYXRvci5qcyIsIklucHV0LmpzIiwiS2V5c3Ryb2tlLmpzIiwiTGluZS5qcyIsIk91dHB1dC5qcyIsIl9jb25maWcuanMiLCJpbmRleC5qcyJdLCJuYW1lcyI6WyJDb21tYW5kIiwiW29iamVjdCBPYmplY3RdIiwiaW5wdXQiLCJvdXRwdXQiLCJ0aGlzIiwicmVhZExlbmd0aCIsIl9pIiwiX28iLCJlbXVsYXRvciIsInF1ZXVlIiwiZW11bGF0ZSIsIiQiLCJlbGVtZW50IiwiYXBwZW5kIiwiRE9NT3BlbiIsIl9pbnB1dCIsInRvU3RyaW5nIiwiX3RleHQiLCJsZW5ndGgiLCJET01DbG9zZSIsInBlbmRpbmdDb21tYW5kIiwiSW5wdXQiLCJLZXlzdHJva2UiLCJwcm9tcHQiLCJsb2NhdGlvbiIsInBlbmRpbmdJbnB1dCIsImN1cnNvckh0bWwiLCJpc1RlbXAiLCJFbXVsYXRvciIsImNvbW1hbmRzIiwidXNlciIsInN5cyIsImNvbnNvbGUiLCJsb2ciLCJzcGxpY2UiLCJjaGFuZ2VTdGF0ZSIsImZhc3RFbXVsYXRlIiwic2Nyb2xsQm90dG9tIiwiZSIsImtleUNvZGUiLCJ1bmRvQ2hhciIsInJlYWQiLCJrZXkiLCJldmFsdWF0ZSIsIkRFQlVHIiwiY29udGFpbmVyIiwicGFyZW50Iiwic2Nyb2xsVG9wIiwicHJvcCIsIm4iLCJzbGljZSIsIl9zdGF0ZSIsInJlcGxhY2VXaXRoIiwiaW5mbyIsInB1c2giLCJPdXRwdXQiLCJMaW5lIiwibmV3U3RhdGUiLCJyZW1vdmUiLCJsb2dTdGF0ZSIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJzdGF0ZUlkIiwic3RhdGVOYW1lIiwicmVhZGluZ1NwZWVkIiwiZW11bGF0aW9uU3BlZWQiLCJlbnRlclBhdXNlIiwiYmFja3NwYWNlUHJvYiIsImlkbGVQcm9iIiwiY3Vyc29ySW50ZXJ2YWwiLCJwcmVFbXVsYXRpb25IdG1sIiwiaHRtbCIsImN1cnNvcnNDdXJyZW50bHlTaG93biIsInRleHQiLCJjc3MiLCJ0YWJzIiwicmVhbFRleHQiLCJyZXBsYWNlIiwiX2NzcyIsIl90YWJzIiwiY3V0b2ZmIiwiaXNJbnB1dCIsImluc2VydEN1cnNvciIsInJlcHJlc2VudGF0aW9uIiwiX0RPTU9wZW4iLCJzdWJzdHJpbmciLCJfdGFiU3RyaW5nIiwiX0RPTUNsb3NlIiwiX3R5cGUiLCJjdXJyZW50Q3V0b2ZmIiwic2V0VGltZW91dCIsImJpbmQiLCJsb3R0ZXJ5IiwiTWF0aCIsInJhbmRvbSIsIm5ld0N1dG9mZiIsIm1heCIsIm1pbiIsInJlcGVhdCIsImtleXN0cm9rZXMiLCJfa2V5c3Ryb2tlcyIsImkiLCJkaXNwbGF5Q3Vyc29yIiwiX291dHB1dCIsImR1cmF0aW9uIiwiaW5wdXRSZXByZXNlbnRhdGlvbiIsIndyaXRlIiwibmV4dENvbW1hbmQiLCJwYXVzZUR1cmF0aW9uIiwiUEFDS0FHRV9UQUciLCJjdXJzb3JCbGlua2luZyIsInRlcm1pbmFsRW11bGF0b3JJbml0Iiwic2V0SW50ZXJ2YWwiLCJjdXJzb3JCbGluayIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJ0ZXJtaW5hbEVtdWxhdG9yUGFnZWxvYWRlZFdyYXBwZXIiLCJhdHRhY2hFdmVudCIsInRlcm1pbmFsRW11bGF0b3JET01SZWFkeSIsIndhcm4iLCJlcnJvciIsInRlcm1pbmFsRW11bGF0b3JQYWdlbG9hZGVkIiwiZG9jdW1lbnQiLCJvbmxvYWQiXSwibWFwcGluZ3MiOiJBQUFBLE1BQUFBLFFBQ0FDLFlBQUFDLEVBQUFDLEdBQ0FDLEtBQUFDLFdBQUEsRUFDQUQsS0FBQUUsR0FBQUosRUFDQUUsS0FBQUcsR0FBQUosRUFDQUMsS0FBQUMsV0FBQUgsRUFBQUcsV0FBQUYsRUFBQUUsV0FFQUosUUFBQU8sRUFBQUMsR0FHQUwsS0FBQUUsR0FBQUksUUFBQUYsRUFBQUosS0FBQUcsR0FBQUUsR0FFQVIsWUFBQU8sR0FDQUcsRUFBQUgsRUFBQUksU0FBQUMsT0FBQWIsUUFBQWMsU0FBQSxHQUNBVixLQUFBRSxHQUFBUyxPQUFBQyxT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QSxtQkFBQVksMkJBQ0FBLDhCQUVBekYsUUFBQXVGLEtBQUFWLFlBQ0EsbURBQ0EsR0FJQSxTQUFBSSxjQUNBekMsdUJBQ0E3RCxFQUFBLHdCQUFBaUQsWUFBQSxTQUNBWSx1QkFBQSxJQUVBN0QsRUFBQSx3QkFBQWtELFNBQUEsU0FDQVcsdUJBQUEsR0E5Q0FrRCxTQUFBUCxpQkFDQU8sU0FBQVAsaUJBQUEsbUJBQUFKLHNCQUFBLEdBQ0FXLFNBQUFMLFlBQ0FLLFNBQUFMLFlBQUEscUJBQUFOLHNCQUNBRyxPQUFBUyxPQUFBWiIsImZpbGUiOiJtYWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIENvbW1hbmQge1xuICBjb25zdHJ1Y3RvcihpbnB1dCwgb3V0cHV0KSB7XG4gICAgdGhpcy5yZWFkTGVuZ3RoID0gMDtcbiAgICB0aGlzLl9pID0gaW5wdXQ7IC8vIElucHV0IGluc3RhbmNlXG4gICAgdGhpcy5fbyA9IG91dHB1dDsgLy8gT3V0cHV0IGluc3RhbmNlXG4gICAgdGhpcy5yZWFkTGVuZ3RoID0gaW5wdXQucmVhZExlbmd0aCArIG91dHB1dC5yZWFkTGVuZ3RoO1xuICB9XG4gIGVtdWxhdGUoZW11bGF0b3IsIHF1ZXVlKSB7XG4gICAgLyogZW11bGF0aW5nIF9pIGFzeW5jaHJvbm91c2x5IHRha2VzIGNhcmUgb2YgX28sIGFuZCBhbGxcbiAgICBmb2xsb3dpbmcgY29tbWFuZHMuICovXG4gICAgdGhpcy5faS5lbXVsYXRlKGVtdWxhdG9yLCB0aGlzLl9vLCBxdWV1ZSk7XG4gIH1cbiAgZmFzdEVtdWxhdGUoZW11bGF0b3IpIHtcbiAgICAkKGVtdWxhdG9yLmVsZW1lbnQpLmFwcGVuZChDb21tYW5kLkRPTU9wZW4oZmFsc2UpICtcbiAgICB0aGlzLl9pLl9pbnB1dC50b1N0cmluZyh0aGlzLl9pLl9pbnB1dC5fdGV4dC5sZW5ndGggLSAxLFxuICAgICAgdHJ1ZSwgZW11bGF0b3IsIGZhbHNlKSArIHRoaXMuX28udG9TdHJpbmcoKSArIENvbW1hbmQuRE9NQ2xvc2UgK1xuICAgIENvbW1hbmQucGVuZGluZ0NvbW1hbmQoZW11bGF0b3IpKTtcbiAgfVxuICBzdGF0aWMgcGVuZGluZ0NvbW1hbmQoZW11bGF0b3IpIHtcbiAgICByZXR1cm4gQ29tbWFuZC5ET01PcGVuKHRydWUpICsgSW5wdXQuRE9NT3BlbiArIEtleXN0cm9rZS5wcm9tcHQoZW11bGF0b3IpICtcbiAgICBLZXlzdHJva2UubG9jYXRpb24oZW11bGF0b3IpICsgZW11bGF0b3IucGVuZGluZ0lucHV0ICsgSW5wdXQuY3Vyc29ySHRtbCArXG4gICAgSW5wdXQuRE9NQ2xvc2UgKyBDb21tYW5kLkRPTUNsb3NlO1xuICB9XG4gIHN0YXRpYyBET01PcGVuKGlzVGVtcCkge1xuICAgIHJldHVybiBcIjxkaXYgY2xhc3M9J2NvbW1hbmQtY29udGFpbmVyXCIgK1xuICAgIChpc1RlbXAgPyBcIiB0ZW1wXCIgOiBcIlwiKSArIFwiJz5cIjtcbiAgfVxufVxuXG4vLyBcInN0YXRpYyBwcm9wZXJ0aWVzXCJcbkNvbW1hbmQuRE9NQ2xvc2UgPSBcIjwvZGl2PlwiO1xuIiwiY2xhc3MgRW11bGF0b3Ige1xuICBjb25zdHJ1Y3Rvcihjb21tYW5kcywgZWxlbWVudCkge1xuICAgIHRoaXMudXNlciA9IFwicm9vdFwiO1xuICAgIHRoaXMuc3lzID0gXCJub3V0XCI7XG4gICAgdGhpcy5sb2NhdGlvbiA9IFwiflwiO1xuICAgIHRoaXMucGVuZGluZ0lucHV0ID0gXCJcIjtcbiAgICB0aGlzLmNvbW1hbmRzID0gY29tbWFuZHM7XG4gICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDtcbiAgfVxuICBlbXVsYXRlKCkge1xuICAgIGlmKHRoaXMuY29tbWFuZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIkVtdWxhdGUgY2FsbGVkIG9uIGVtcHR5IGVtdWxhdG9yLiBBYm9ydGluZy4uXCIpO1xuICAgICAgcmV0dXJuIDE7XG4gICAgfVxuICAgIC8vIHNwbGl0IGludG8gY3VycmVudCBhbmQgdGFpbFxuICAgIGNvbnN0IGN1cnJlbnRDb21tYW5kID0gdGhpcy5jb21tYW5kcy5zcGxpY2UoMCwgMSk7XG4gICAgY3VycmVudENvbW1hbmRbMF0uZW11bGF0ZSh0aGlzLCB0aGlzLmNvbW1hbmRzKTtcbiAgfVxuICBmYXN0RW11bGF0ZSgpIHtcbiAgICBpZih0aGlzLmNvbW1hbmRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc29sZS5sb2coXCJGYXN0IGVtdWxhdGUgY2FsbGVkIG9uIGVtcHR5IGVtdWxhdG9yLiBBYm9ydGluZy4uXCIpO1xuICAgICAgcmV0dXJuIDE7XG4gICAgfVxuICAgIHdoaWxlKHRoaXMuY29tbWFuZHMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZSgxKTtcbiAgICAgIHRoaXMuY2hhbmdlU3RhdGUoMik7XG4gICAgICBjb25zdCBjdXJyZW50Q29tbWFuZCA9IHRoaXMuY29tbWFuZHMuc3BsaWNlKDAsIDEpO1xuICAgICAgY3VycmVudENvbW1hbmRbMF0uZmFzdEVtdWxhdGUodGhpcyk7XG4gICAgICB0aGlzLnNjcm9sbEJvdHRvbSgpO1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZSgzKTtcbiAgICB9XG4gIH1cbiAgcmVhZFVzZXJJbnB1dChlKSB7XG4gICAgc3dpdGNoKHRydWUpIHtcbiAgICAgIGNhc2UgZS5rZXlDb2RlID09PSA4OiAvLyBiYWNrc3BhY2VcbiAgICAgICAgdGhpcy5zY3JvbGxCb3R0b20oKTtcbiAgICAgICAgdGhpcy51bmRvQ2hhcigxKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIGUua2V5Q29kZSA+PSA2NSAmJiBlLmtleUNvZGUgPD0gOTA6IC8vIGEtWlxuICAgICAgICB0aGlzLnNjcm9sbEJvdHRvbSgpO1xuICAgICAgICB0aGlzLnJlYWQoZS5rZXkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgZS5rZXlDb2RlID09PSAzMjogLy8gc3BhY2VcbiAgICAgICAgdGhpcy5zY3JvbGxCb3R0b20oKTtcbiAgICAgICAgdGhpcy5yZWFkKFwiIFwiKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIGUua2V5Q29kZSA9PT0gMTM6IC8vIGVudGVyIGtleVxuICAgICAgICB0aGlzLnNjcm9sbEJvdHRvbSgpO1xuICAgICAgICB0aGlzLmV2YWx1YXRlKHRoaXMucGVuZGluZ0lucHV0KTtcbiAgICAgICAgLy8gdGhpcy5jaGFuZ2VTdGF0ZSgyKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBpZihERUJVRykgY29uc29sZS5sb2coXCJ1bmtub3duIGtleSBwcmVzc2VkXCIsIGUua2V5Q29kZSwgZSk7XG4gICAgfVxuICB9XG4gIHNjcm9sbEJvdHRvbSgpIHtcbiAgICAvLyBzY3JvbGwgdG8gYm90dG9tIG9mIGNvbnRhaW5lclxuICAgIGlmKERFQlVHKSBjb25zb2xlLmxvZyhcInNjcm9sbGluZyB0byBib3R0b20gb2YgY29udGFpbmVyXCIpO1xuICAgIGxldCBjb250YWluZXIgPSAkKHRoaXMuZWxlbWVudCkucGFyZW50KCk7XG4gICAgY29udGFpbmVyLnNjcm9sbFRvcChjb250YWluZXIucHJvcChcInNjcm9sbEhlaWdodFwiKSk7XG4gIH1cbiAgdW5kb0NoYXIobikge1xuICAgIHRoaXMucGVuZGluZ0lucHV0LnNsaWNlKDAsIC1uKTtcbiAgfVxuICByZWFkKGlucHV0KSB7XG4gICAgaWYodGhpcy5fc3RhdGUgIT09IDMpIHJldHVybiAtMTtcbiAgICBpZihERUJVRykgY29uc29sZS5sb2coXCJyZWFkaW5nICdcIiArIGlucHV0ICsgXCInLi5cIik7XG4gICAgdGhpcy5wZW5kaW5nSW5wdXQgKz0gaW5wdXQ7XG4gICAgLy8gdXBkYXRlIGN1cnJlbnRcbiAgICAkKFwiLmNvbW1hbmQtY29udGFpbmVyLnRlbXBcIikucmVwbGFjZVdpdGgoQ29tbWFuZC5wZW5kaW5nQ29tbWFuZChlbXVsYXRvcikpO1xuICB9XG4gIGV2YWx1YXRlKGlucHV0KSB7XG4gICAgaWYoREVCVUcpIGNvbnNvbGUuaW5mbyhcIltFTVVMQVRPUl0gZXZhbHVhdGluZyAnXCIgKyBpbnB1dCArIFwiJy4uXCIpO1xuICAgIC8vIHRlbXBvcmFyeSBzb2x1dGlvbiwgc2VlIGlzc3VlICMzXG4gICAgY29uc3Qgb3V0cHV0ID0gXCJUaGF0IGRpZG4ndCB3b3JrLi48YnI+VHJ5IHNvbWV0aGluZyBlbHNlP1wiO1xuICAgIC8vICQodGhpcy5lbGVtZW50KS5maW5kKFwiLmNvbW1hbmQtY29udGFpbmVyLnRlbXBcIikucmVtb3ZlQ2xhc3MoXCJ0ZW1wXCIpO1xuICAgIHRoaXMuY29tbWFuZHMucHVzaChcbiAgICAgIG5ldyBDb21tYW5kKFxuICAgICAgICBuZXcgSW5wdXQobmV3IEtleXN0cm9rZShpbnB1dCwgXCJ3aGl0ZVwiLCAwKSksXG4gICAgICAgIG5ldyBPdXRwdXQoW1xuICAgICAgICAgIG5ldyBMaW5lKFtuZXcgS2V5c3Ryb2tlKG91dHB1dCwgXCJ5ZWxsb3dcIiwgMCldKVxuICAgICAgICBdKVxuICAgICAgKVxuICAgICk7XG4gICAgdGhpcy5mYXN0RW11bGF0ZSgpO1xuICB9XG4gIGNoYW5nZVN0YXRlKG5ld1N0YXRlKSB7XG4gICAgdGhpcy5fc3RhdGUgPSBuZXdTdGF0ZTtcbiAgICBzd2l0Y2gobmV3U3RhdGUpIHtcbiAgICAgIGNhc2UgMTogLy8gZW11bGF0aW5nIGlucHV0XG4gICAgICAgIC8vIGdldCByaWQgb2YgYWVzdGhldGljLCB0ZW1wb3JhcnkgY29tbWFuZHNcbiAgICAgICAgJChcIi5jb21tYW5kLWNvbnRhaW5lci50ZW1wXCIpLnJlbW92ZSgpO1xuICAgICAgICBFbXVsYXRvci5sb2dTdGF0ZShuZXdTdGF0ZSwgXCJlbXVsYXRpbmdcIik7XG4gICAgICAgICQodGhpcy5lbGVtZW50KVxuICAgICAgICAucmVtb3ZlQ2xhc3MoXCJoaWRkZW4gd3JpdGluZyByZWFkaW5nIGlkbGVcIilcbiAgICAgICAgLmFkZENsYXNzKFwiZW11bGF0aW5nXCIpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMjogLy8gd3JpdGluZyBvdXRwdXRcbiAgICAgICAgRW11bGF0b3IubG9nU3RhdGUobmV3U3RhdGUsIFwid3JpdGluZ1wiKTtcbiAgICAgICAgdGhpcy5wZW5kaW5nSW5wdXQgPSBcIlwiO1xuICAgICAgICAkKHRoaXMuZWxlbWVudClcbiAgICAgICAgLnJlbW92ZUNsYXNzKFwiaGlkZGVuIGVtdWxhdGluZyByZWFkaW5nIGlkbGVcIilcbiAgICAgICAgLmFkZENsYXNzKFwid3JpdGluZ1wiKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDM6IC8vIHJlYWRpbmcgaW5wdXRcbiAgICAgICAgRW11bGF0b3IubG9nU3RhdGUobmV3U3RhdGUsIFwicmVhZGluZ1wiKTtcbiAgICAgICAgJCh0aGlzLmVsZW1lbnQpXG4gICAgICAgIC5yZW1vdmVDbGFzcyhcImhpZGRlbiBlbXVsYXRpbmcgd3JpdGluZyBpZGxlXCIpXG4gICAgICAgIC5hZGRDbGFzcyhcInJlYWRpbmdcIik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSA0OiAvLyBoaWRkZW5cbiAgICAgICAgRW11bGF0b3IubG9nU3RhdGUobmV3U3RhdGUsIFwiaGlkZGVuXCIpO1xuICAgICAgICAkKHRoaXMuZWxlbWVudClcbiAgICAgICAgLnJlbW92ZUNsYXNzKFwiZW11bGF0aW5nIHdyaXRpbmcgcmVhZGluZyBpZGxlXCIpXG4gICAgICAgIC5hZGRDbGFzcyhcImhpZGRlblwiKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6IC8vIGlkbGVcbiAgICAgIHRoaXMuX3N0YXRlID0gLTE7XG4gICAgICAgIEVtdWxhdG9yLmxvZ1N0YXRlKG5ld1N0YXRlLCBcImlkbGVcIik7XG4gICAgICAgICQodGhpcy5lbGVtZW50KVxuICAgICAgICAucmVtb3ZlQ2xhc3MoXCJoaWRkZW4gZW11bGF0aW5nIHdyaXRpbmcgcmVhZGluZ1wiKVxuICAgICAgICAuYWRkQ2xhc3MoXCJpZGxlXCIpO1xuICAgIH1cbiAgfVxuICBzdGF0aWMgbG9nU3RhdGUoc3RhdGVJZCwgc3RhdGVOYW1lKSB7XG4gICAgaWYoREVCVUcpIGNvbnNvbGUuaW5mbyhcIltFTVVMQVRPUl0gY2hhbmdpbmcgc3RhdGUgdG8gJ1wiICsgc3RhdGVJZCArXG4gICAgXCInLFxcbiBpLmUuOiAnXCIgKyBzdGF0ZU5hbWUgKyBcIicuLlwiKTtcbiAgfVxufVxuXG4vLyBcInN0YXRpYyBwcm9wZXJ0aWVzXCJcbkVtdWxhdG9yLnJlYWRpbmdTcGVlZCA9IDcwOyAvLyBtcyBwZXIgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVyXG5FbXVsYXRvci5lbXVsYXRpb25TcGVlZCA9IDEyMDsgLy8gbXMgcGVyIGNoYXJhY3RlclxuLy8gRW11bGF0b3IuZW11bGF0aW9uU3BlZWQgPSAxMDAwMDAwMDsgLy8gbXMgcGVyIGNoYXJhY3RlclxuRW11bGF0b3IuZW50ZXJQYXVzZSA9IDUwMDsgLy8gdGltZW91dCBiZWZvcmUgXCJwcmVzc2luZyBlbnRlclwiXG5FbXVsYXRvci5iYWNrc3BhY2VQcm9iID0gMC4xOyAvLyBwcm9iYWJpbGl0eSBvZiB1bmRvaW5nIGEgY2hhcmFjdGVyXG5FbXVsYXRvci5pZGxlUHJvYiA9IDAuMjsgLy8gcHJvYmFiaWxpdHkgb2YgZG9pbmcgbm90aGluZ1xuRW11bGF0b3IuY3Vyc29ySW50ZXJ2YWwgPSA3MDA7IC8vIGJsaW5raW5nIGludGVydmFsIChtcylcbiIsImNsYXNzIElucHV0IHtcbiAgY29uc3RydWN0b3IoaW5wdXQpIHtcbiAgICB0aGlzLl9pbnB1dCA9IGlucHV0OyAvLyBLZXlzdHJva2UgaW5zdGFuY2VcbiAgfVxuICBlbXVsYXRlKGVtdWxhdG9yLCBvdXRwdXQsIHF1ZXVlKSB7XG4gICAgZW11bGF0b3IuY2hhbmdlU3RhdGUoMSk7XG4gICAgY29uc3QgcHJlRW11bGF0aW9uSHRtbCA9ICQoZW11bGF0b3IuZWxlbWVudCkuaHRtbCgpO1xuICAgIHRoaXMuX2lucHV0LmVtdWxhdGUoZW11bGF0b3IsIG91dHB1dCwgcXVldWUsIHByZUVtdWxhdGlvbkh0bWwpO1xuICB9XG4gIHN0YXRpYyBnZXQgY3Vyc29ySHRtbCgpIHtcbiAgICByZXR1cm4gXCI8ZGl2IGNsYXNzPSdjdXJzb3JcIiArIChjdXJzb3JzQ3VycmVudGx5U2hvd24gPyBcIiBzaG93blwiIDogXCJcIikgK1xuICAgIFwiJz48L2Rpdj5cIjtcbiAgfVxufVxuXG4vLyBcInN0YXRpYyBwcm9wZXJ0aWVzXCJcbklucHV0LkRPTU9wZW4gPSBcIjxkaXYgY2xhc3M9J2lucHV0Jz48ZGl2IGNsYXNzPSdsaW5lJz5cIjtcbklucHV0LkRPTUNsb3NlID0gXCI8L2Rpdj48L2Rpdj5cIjtcbiIsImNsYXNzIEtleXN0cm9rZSB7XG4gIGNvbnN0cnVjdG9yKHRleHQsIGNzcywgdGFicykge1xuICAgIGNvbnN0IHJlYWxUZXh0ID0gdGV4dDsgLy8gcHJldmVudCByZXBsYWNlbWVudCBjaGFuZ2VzXG4gICAgdGhpcy5yZWFkTGVuZ3RoID0gdGV4dC5yZXBsYWNlKC9cXHMvZywgJycpLmxlbmd0aDtcbiAgICB0aGlzLl90ZXh0ID0gcmVhbFRleHQ7XG4gICAgdGhpcy5fY3NzID0gY3NzO1xuICAgIHRoaXMuX3RhYnMgPSB0YWJzO1xuICB9XG4gIHRvU3RyaW5nKGN1dG9mZiwgaXNJbnB1dCwgZW11bGF0b3IsIGluc2VydEN1cnNvcikge1xuICAgIGxldCByZXByZXNlbnRhdGlvbiA9IGlzSW5wdXQgPyBJbnB1dC5ET01PcGVuICsgS2V5c3Ryb2tlLnByb21wdChlbXVsYXRvcikgK1xuICAgIEtleXN0cm9rZS5sb2NhdGlvbihlbXVsYXRvcikgOiBcIlwiO1xuICAgIHJlcHJlc2VudGF0aW9uICs9IEtleXN0cm9rZS5fRE9NT3Blbih0aGlzLl9jc3MpO1xuICAgIGlmKHR5cGVvZiBjdXRvZmYgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIC8vIHVzZWQgZm9yIGVtdWxhdGlvbiAoaW5wdXQpXG4gICAgICByZXByZXNlbnRhdGlvbiArPSB0aGlzLl90ZXh0LnN1YnN0cmluZygwLCBjdXRvZmYgKyAxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gdXNlZCBmb3Igc2ltcGxlIGRpc3BsYXkgY2FsbHMgKG91dHB1dClcbiAgICAgIHJlcHJlc2VudGF0aW9uICs9IHRoaXMuX3RleHQgKyBLZXlzdHJva2UuX3RhYlN0cmluZyh0aGlzLl90YWJzKTtcbiAgICB9XG4gICAgcmVwcmVzZW50YXRpb24gKz0gS2V5c3Ryb2tlLl9ET01DbG9zZTsgLy8gY2xvc2Ugb2ZmIGtleXN0cm9rZVxuICAgIHJlcHJlc2VudGF0aW9uICs9IGluc2VydEN1cnNvciA/IElucHV0LmN1cnNvckh0bWwgOiBcIlwiOyAvLyBhZGQgY3Vyc29yXG4gICAgcmVwcmVzZW50YXRpb24gKz0gaXNJbnB1dCA/IElucHV0LkRPTUNsb3NlIDogXCJcIjtcbiAgICByZXR1cm4gcmVwcmVzZW50YXRpb247XG4gIH1cbiAgZW11bGF0ZShlbXVsYXRvciwgb3V0cHV0LCBxdWV1ZSwgcHJlRW11bGF0aW9uSHRtbCkge1xuICAgIHRoaXMuX3R5cGUoZW11bGF0b3IsIG91dHB1dCwgcXVldWUsIHByZUVtdWxhdGlvbkh0bWwsIDApO1xuICB9XG4gIF90eXBlKGVtdWxhdG9yLCBvdXRwdXQsIHF1ZXVlLCBwcmVFbXVsYXRpb25IdG1sLCBjdXJyZW50Q3V0b2ZmKSB7XG4gICAgLy8gdXBkYXRlIGVtdWxhdG9yIGh0bWxcbiAgICBjb25zdCByZXByZXNlbnRhdGlvbiA9IENvbW1hbmQuRE9NT3BlbihmYWxzZSkgK1xuICAgIHRoaXMudG9TdHJpbmcoY3VycmVudEN1dG9mZiwgdHJ1ZSwgZW11bGF0b3IsIHRydWUpICsgQ29tbWFuZC5ET01DbG9zZTtcbiAgICAkKGVtdWxhdG9yLmVsZW1lbnQpLmh0bWwocHJlRW11bGF0aW9uSHRtbCArIHJlcHJlc2VudGF0aW9uKTtcbiAgICAvLyB1cGRhdGUgJiBjYWxsYmFja1xuICAgIGlmKGN1cnJlbnRDdXRvZmYgPj0gdGhpcy5fdGV4dC5sZW5ndGggLSAxKSB7XG4gICAgICAvLyBlbmQgcmVhY2hlZC4gcGF1c2UgYW5kIHNob3cgb3V0cHV0XG4gICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICBvdXRwdXQuZW11bGF0ZShcbiAgICAgICAgICBlbXVsYXRvciwgcHJlRW11bGF0aW9uSHRtbCwgdGhpcy50b1N0cmluZyh2b2lkKDApLCB0cnVlLCBlbXVsYXRvcilcbiAgICAgICAgKTtcbiAgICAgIH0uYmluZCh0aGlzKSwgRW11bGF0b3IuZW50ZXJQYXVzZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGxvdHRlcnkgPSBNYXRoLnJhbmRvbSgpO1xuICAgICAgbGV0IG5ld0N1dG9mZiA9IGN1cnJlbnRDdXRvZmY7XG4gICAgICBpZihsb3R0ZXJ5IDwgRW11bGF0b3IuYmFja3NwYWNlUHJvYikge1xuICAgICAgICAvLyB1bmRvIGxhc3QgY2hhcmFjdGVyXG4gICAgICAgIG5ld0N1dG9mZiA9IE1hdGgubWF4KDAsIGN1cnJlbnRDdXRvZmYgLSAxKTtcbiAgICAgIH0gZWxzZSBpZihsb3R0ZXJ5ID49IEVtdWxhdG9yLmJhY2tzcGFjZVByb2IgKyBFbXVsYXRvci5pZGxlUHJvYikge1xuICAgICAgICAvLyBcInR5cGVcIlxuICAgICAgICBuZXdDdXRvZmYgPSBNYXRoLm1pbihjdXJyZW50Q3V0b2ZmICsgMSwgdGhpcy5fdGV4dC5sZW5ndGggLSAxKTtcbiAgICAgIH0gLy8gZWxzZTogaWRsZVxuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5fdHlwZShlbXVsYXRvciwgb3V0cHV0LCBxdWV1ZSwgcHJlRW11bGF0aW9uSHRtbCwgbmV3Q3V0b2ZmKTtcbiAgICAgIH0uYmluZCh0aGlzKSwgRW11bGF0b3IuZW11bGF0aW9uU3BlZWQpO1xuICAgIH1cbiAgfVxuICBzdGF0aWMgcHJvbXB0KGVtdWxhdG9yKSB7XG4gICAgcmV0dXJuIFwiPHNwYW4gY2xhc3M9J3Byb21wdCc+XCIgKyBlbXVsYXRvci51c2VyICsgXCJAXCIgKyBlbXVsYXRvci5zeXMgKyBcIjwvc3Bhbj46XCI7XG4gIH1cbiAgc3RhdGljIGxvY2F0aW9uKGVtdWxhdG9yKSB7XG4gICAgcmV0dXJuIFwiPHNwYW4gY2xhc3M9J2xvY2F0aW9uJz5cIiArIGVtdWxhdG9yLmxvY2F0aW9uICsgXCI8L3NwYW4+Jm5ic3A7XCI7XG4gIH1cbiAgc3RhdGljIF9ET01PcGVuKGNzcykge1xuICAgIHJldHVybiBcIjxzcGFuIGNsYXNzPSdcIiArIGNzcyArIFwiJz5cIjtcbiAgfVxuICBzdGF0aWMgX3RhYlN0cmluZyhuKSB7XG4gICAgcmV0dXJuIFwiJm5ic3A7XCIucmVwZWF0KDQgKiBuKTtcbiAgfVxufVxuXG4vLyBcInN0YXRpYyBwcm9wZXJ0aWVzXCJcbktleXN0cm9rZS5fRE9NQ2xvc2UgPSBcIjwvc3Bhbj5cIjtcbiIsImNsYXNzIExpbmUge1xuICBjb25zdHJ1Y3RvcihrZXlzdHJva2VzKSB7XG4gICAgdGhpcy5yZWFkTGVuZ3RoID0gMDtcbiAgICB0aGlzLl9rZXlzdHJva2VzID0ga2V5c3Ryb2tlcztcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwga2V5c3Ryb2tlcy5sZW5ndGg7IGkrKylcbiAgICAgIHRoaXMucmVhZExlbmd0aCArPSBrZXlzdHJva2VzW2ldLnJlYWRMZW5ndGg7XG4gIH1cbiAgdG9TdHJpbmcoY3V0b2ZmLCBkaXNwbGF5Q3Vyc29yKSB7XG4gICAgbGV0IHJlcHJlc2VudGF0aW9uID0gTGluZS5fRE9NT3BlbjtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5fa2V5c3Ryb2tlcy5sZW5ndGg7IGkrKylcbiAgICAgIHJlcHJlc2VudGF0aW9uICs9IHRoaXMuX2tleXN0cm9rZXNbaV0udG9TdHJpbmcoKTtcbiAgICBpZihkaXNwbGF5Q3Vyc29yKSByZXByZXNlbnRhdGlvbiArPSBJbnB1dC5jdXJzb3JIdG1sKCk7XG4gICAgcmV0dXJuIHJlcHJlc2VudGF0aW9uICsgTGluZS5fRE9NQ2xvc2U7XG4gIH1cbn1cblxuLy8gXCJzdGF0aWMgcHJvcGVydGllc1wiXG5MaW5lLl9ET01PcGVuID0gXCI8ZGl2IGNsYXNzPSdsaW5lJz5cIjtcbkxpbmUuX0RPTUNsb3NlID0gXCI8L2Rpdj5cIjtcbiIsImNsYXNzIE91dHB1dCB7XG4gIGNvbnN0cnVjdG9yKG91dHB1dCkge1xuICAgIHRoaXMucmVhZExlbmd0aCA9IDA7XG4gICAgdGhpcy5fb3V0cHV0ID0gb3V0cHV0OyAvLyBhcnJheSBvZiBMaW5lIGluc3RhbmNlc1xuICAgIGZvcihsZXQgaSA9IDA7IGkgPCBvdXRwdXQubGVuZ3RoOyBpKyspXG4gICAgICB0aGlzLnJlYWRMZW5ndGggKz0gb3V0cHV0W2ldLnJlYWRMZW5ndGg7XG4gIH1cbiAgdG9TdHJpbmcoKSB7XG4gICAgbGV0IHJlcHJlc2VudGF0aW9uID0gT3V0cHV0Ll9ET01PcGVuO1xuICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLl9vdXRwdXQubGVuZ3RoOyBpKyspXG4gICAgICByZXByZXNlbnRhdGlvbiArPSB0aGlzLl9vdXRwdXRbaV0udG9TdHJpbmcoKTtcbiAgICByZXR1cm4gcmVwcmVzZW50YXRpb24gKyBPdXRwdXQuX0RPTUNsb3NlO1xuICB9XG4gIHBhdXNlRHVyYXRpb24oKSB7XG4gICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLnJlYWRMZW5ndGggKiBFbXVsYXRvci5yZWFkaW5nU3BlZWQ7XG4gICAgcmV0dXJuIERFQlVHID8gZHVyYXRpb24gKiAuMyA6IGR1cmF0aW9uO1xuICB9XG4gIGVtdWxhdGUoZW11bGF0b3IsIHByZUVtdWxhdGlvbkh0bWwsIGlucHV0UmVwcmVzZW50YXRpb24pIHtcbiAgICBlbXVsYXRvci5jaGFuZ2VTdGF0ZSgyKTtcbiAgICB0aGlzLndyaXRlKGVtdWxhdG9yLCBwcmVFbXVsYXRpb25IdG1sLCBpbnB1dFJlcHJlc2VudGF0aW9uKTtcbiAgICAvLyBvbiB0byB0aGUgbmV4dCByb3VuZFxuICAgIGVtdWxhdG9yLmNoYW5nZVN0YXRlKDMpO1xuICAgIGlmKGVtdWxhdG9yLmNvbW1hbmRzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IG5leHRDb21tYW5kID0gZW11bGF0b3IuY29tbWFuZHMuc3BsaWNlKDAsIDEpO1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgbmV4dENvbW1hbmRbMF0uZW11bGF0ZShlbXVsYXRvciwgZW11bGF0b3IuY29tbWFuZHMpO1xuICAgICAgfSwgdGhpcy5wYXVzZUR1cmF0aW9uKCkpO1xuICAgIH1cbiAgfVxuICB3cml0ZShlbXVsYXRvciwgcHJlRW11bGF0aW9uSHRtbCwgaW5wdXRSZXByZXNlbnRhdGlvbikge1xuICAgICQoZW11bGF0b3IuZWxlbWVudCkuaHRtbChcbiAgICAgIHByZUVtdWxhdGlvbkh0bWwgKyBDb21tYW5kLkRPTU9wZW4oZmFsc2UpICsgaW5wdXRSZXByZXNlbnRhdGlvbiArXG4gICAgICB0aGlzLnRvU3RyaW5nKCkgKyBDb21tYW5kLkRPTUNsb3NlICsgQ29tbWFuZC5wZW5kaW5nQ29tbWFuZChlbXVsYXRvcilcbiAgICApO1xuICAgIGVtdWxhdG9yLnNjcm9sbEJvdHRvbSgpO1xuICB9XG59XG5cbi8vIFwic3RhdGljIHByb3BlcnRpZXNcIlxuT3V0cHV0Ll9ET01PcGVuID0gXCI8ZGl2IGNsYXNzPSdvdXRwdXQnPlwiO1xuT3V0cHV0Ll9ET01DbG9zZSA9IFwiPC9kaXY+XCI7XG4iLCJjb25zdCBERUJVRyA9IHRydWU7XHJcbiIsImNvbnN0IFBBQ0tBR0VfVEFHID0gXCJbdGVybWluYWwtZW11bGF0b3JdIC0gXCI7XG5sZXQgY3Vyc29yc0N1cnJlbnRseVNob3duID0gdHJ1ZTtcbmxldCBjdXJzb3JCbGlua2luZztcblxuLy8gZXZlbnQgbGlzdGVuZXJzXG5pZiAoZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcilcbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgdGVybWluYWxFbXVsYXRvckluaXQsIGZhbHNlKTtcbmVsc2UgaWYgKGRvY3VtZW50LmF0dGFjaEV2ZW50KVxuICBkb2N1bWVudC5hdHRhY2hFdmVudChcIm9ucmVhZHlzdGF0ZWNoYW5nZVwiLCB0ZXJtaW5hbEVtdWxhdG9ySW5pdCk7XG5lbHNlIHdpbmRvdy5vbmxvYWQgPSB0ZXJtaW5hbEVtdWxhdG9ySW5pdDtcblxuLy8gY2FsbHMgY2xpZW50J3MgaW1wbGVtZW50YXRpb25zIGF0IHJpZ2h0IHRpbWVzXG5mdW5jdGlvbiB0ZXJtaW5hbEVtdWxhdG9ySW5pdCgpIHtcbiAgaWYgKERFQlVHKSBjb25zb2xlLmxvZyhQQUNLQUdFX1RBRyArIFwiRE9NIHJlYWR5OyBpbml0aWFsaXNpbmcgLi4uXCIpO1xuICAvLyBzaW11bGF0ZSBjdXJzb3IgYmxpbmtpbmdcbiAgY3Vyc29yQmxpbmtpbmcgPSBzZXRJbnRlcnZhbChjdXJzb3JCbGluaywgRW11bGF0b3IuY3Vyc29ySW50ZXJ2YWwpO1xuICAvLyB3YWl0IGZvciBwYWdlIGxvYWRcbiAgaWYgKHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKVxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLCB0ZXJtaW5hbEVtdWxhdG9yUGFnZWxvYWRlZFdyYXBwZXIsIGZhbHNlKTtcbiAgZWxzZSBpZiAod2luZG93LmF0dGFjaEV2ZW50KVxuICAgIHdpbmRvdy5hdHRhY2hFdmVudChcIm9ubG9hZFwiLCB0ZXJtaW5hbEVtdWxhdG9yUGFnZWxvYWRlZFdyYXBwZXIpO1xuICAvLyBjYWxsIERPTVJlYWR5XG4gIGlmICh0eXBlb2YgdGVybWluYWxFbXVsYXRvckRPTVJlYWR5ID09PSBcImZ1bmN0aW9uXCIpXG4gICAgcmV0dXJuIHRlcm1pbmFsRW11bGF0b3JET01SZWFkeSgpO1xuICBlbHNlIHtcbiAgICBjb25zb2xlLndhcm4oUEFDS0FHRV9UQUcgK1xuICAgICAgXCJ0ZXJtaW5hbEVtdWxhdG9yRE9NUmVhZHkoKSBzaG91bGQgYmUgZGVmaW5lZCFcIik7XG4gICAgcmV0dXJuIDE7XG4gIH1cbn1cblxuZnVuY3Rpb24gdGVybWluYWxFbXVsYXRvclBhZ2Vsb2FkZWRXcmFwcGVyKCkge1xuICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKFBBQ0tBR0VfVEFHICtcbiAgICBcIlBhZ2UgbG9hZGVkOyBpbml0aWFsaXNpbmcgdHJpZ2dlcihzKSAuLi5cIik7XG4gIGlmICh0eXBlb2YgJCAhPT0gXCJmdW5jdGlvblwiKVxuICAgIGNvbnNvbGUuZXJyb3IoUEFDS0FHRV9UQUcgKyBcInlvdSBuZWVkIHRvIGxvYWQgSlF1ZXJ5IGJlZm9yZSBsb2FkaW5nIG1lIVwiKTtcbiAgaWYgKHR5cGVvZiB0ZXJtaW5hbEVtdWxhdG9yUGFnZWxvYWRlZCA9PT0gXCJmdW5jdGlvblwiKVxuICAgIHJldHVybiB0ZXJtaW5hbEVtdWxhdG9yUGFnZWxvYWRlZCgpO1xuICBlbHNlIHtcbiAgICBjb25zb2xlLndhcm4oUEFDS0FHRV9UQUcgK1xuICAgICAgXCJ0ZXJtaW5hbEVtdWxhdG9yUGFnZUxvYWRlZCgpIHNob3VsZCBiZSBkZWZpbmVkIVwiKTtcbiAgICByZXR1cm4gMTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjdXJzb3JCbGluaygpIHtcbiAgaWYgKGN1cnNvcnNDdXJyZW50bHlTaG93bikge1xuICAgICQoXCIuaW5wdXQgLmxpbmUgLmN1cnNvclwiKS5yZW1vdmVDbGFzcyhcInNob3duXCIpO1xuICAgIGN1cnNvcnNDdXJyZW50bHlTaG93biA9IGZhbHNlO1xuICB9IGVsc2Uge1xuICAgICQoXCIuaW5wdXQgLmxpbmUgLmN1cnNvclwiKS5hZGRDbGFzcyhcInNob3duXCIpO1xuICAgIGN1cnNvcnNDdXJyZW50bHlTaG93biA9IHRydWU7XG4gIH1cbn1cbiJdfQ==
